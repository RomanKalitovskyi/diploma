var w=Object.defineProperty;var v=(a,t,e)=>t in a?w(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var c=(a,t,e)=>(v(a,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerpolicy&&(r.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?r.credentials="include":s.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();class g{constructor(t,e,i){this.x=t,this.y=e,this.radians=i}get sin(){return Math.sin(this.radians)}get cos(){return Math.cos(this.radians)}distance(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}angleTo(t){return Math.atan2(t.y-this.y,t.x-this.x)}rotate(t){return this.radians=(this.radians+t)%(2*Math.PI)+(Math.random()-.5)*.001,this}moveForward(t=1,e,i){const s=this.x+this.cos*t,r=this.y+this.sin*t,n=s<0||s>e?Math.PI-this.radians:this.radians,d=r<0||r>i?2*Math.PI-n:n;return this.radians=d,this.x=s<0?-s:s>e?e-(s-e):s,this.y=r<0?-r:r>i?i-(r-i):r,this}static randomInRectangle(t,e){return new g(Math.random()*t,Math.random()*e,Math.random()*2*Math.PI)}rotateTowards(t){const i=this.angleTo(t)-this.radians;return this.rotate(i),this}stayInBounds(t,e){this.x<0?this.x=0:this.x>t&&(this.x=t),this.y<0?this.y=0:this.y>e&&(this.y=e)}}var u=(a=>(a.storage="storage",a.source="source",a))(u||{});function S(a,t,e,i,s){switch(a.fillStyle=i,t){case"source":a.beginPath(),a.arc(e.x,e.y,s/2,0,2*Math.PI),a.fill();break;case"storage":a.fillRect(e.x,e.y,s,s);break}}class I{constructor(t,e,i){this.location=t,this.color=e,this.type=i}draw(t){S(t,this.type,this.location,this.color,10)}}var y=(a=>(a.red="#ff0000",a.green="#009900",a))(y||{});function R(a){switch(a){case"#ff0000":return"#ffaaaa";case"#009900":return"#aaffaa"}}const l=10,b=10,E=60,f=1;class P{constructor(t,e,i,s,r,n,d){c(this,"target",null);c(this,"targetName",null);c(this,"prevTarget",null);c(this,"distanceToSource",1e4);c(this,"distanceToStorage",1e4);c(this,"speedCoefficient",Math.random()*.5+.75);this.name=t,this.location=e,this.type=i,this.color=s,this.getMessages=r,this.sendMessage=n,this.reachedTarget=d}receiveMessages(){return this.getMessages(this).map(e=>{const i=e.split(",");return{x:parseFloat(i[0]),y:parseFloat(i[1]),color:i[2],distanceToSource:parseFloat(i[3]),distanceToStorage:parseFloat(i[4]),name:i[5]}})}emitMessage(){this.sendMessage(this,`${this.location.x},${this.location.y},${this.color},${this.distanceToSource*1.15+f},${this.distanceToStorage*1.15+f},${this.name}`)}step(t,e){this.emitMessage();const s=this.receiveMessages();this.reachedTarget(this)&&(this.target=null,this.type===u.source?this.distanceToSource=0:this.distanceToStorage=0,this.location.rotate(Math.PI),this.type=this.type===u.source?u.storage:u.source);const n=s.filter(o=>o.color===this.color).reduce((o,h)=>{if(!o)return h;const m=new g(h.x,h.y,0),T=this.location.distance(m)+h.distanceToSource,p=new g(o.x,o.y,0),M=this.location.distance(p)+o.distanceToSource;return T<M?h:o},null),d=s.filter(o=>o.color===this.color).reduce((o,h)=>{if(!o)return h;const m=new g(h.x,h.y,0),T=this.location.distance(m)+h.distanceToStorage,p=new g(o.x,o.y,0),M=this.location.distance(p)+o.distanceToStorage;return T<M?h:o},null);if(n){const o=new g(n.x,n.y,0),h=this.location.distance(o)+n.distanceToSource;h<this.distanceToSource&&(this.distanceToSource=h,this.type===u.source&&n.name!==this.targetName&&(this.targetName=n.name,this.target=o,this.location.rotateTowards(o)))}if(d){const o=new g(d.x,d.y,0),h=this.location.distance(o)+d.distanceToStorage;h<this.distanceToStorage&&(this.distanceToStorage=h,this.type===u.storage&&d.name!==this.targetName&&(this.targetName=d.name,this.target=o,this.location.rotateTowards(o)))}this.distanceToSource+=f,this.distanceToStorage+=f,this.location.moveForward(f*this.speedCoefficient*(Math.random()*.2+.9),t,e),this.target===this.prevTarget&&(this.target=null),this.prevTarget=this.target}draw(t){const{x:e,y:i,radians:s}=this.location;t.fillStyle=R(this.color),t.save(),t.translate(e+l/2,i+l/2),t.rotate(s),t.beginPath(),t.moveTo(-l/2,-l/2),t.lineTo(l/2,0),t.lineTo(-l/2,l/2),t.closePath(),t.fill(),t.restore(),this.type===u.storage&&(t.save(),t.translate(e+l/2,i+l/2),t.beginPath(),t.arc(0,0,2,0,2*Math.PI),t.fillStyle=this.color,t.fill(),t.restore()),this.target&&(t.beginPath(),t.moveTo(e+l/2,i+l/2),t.lineTo(this.target.x,this.target.y),t.strokeStyle=this.color,t.stroke())}}class C{constructor(t,e){c(this,"robots",[]);c(this,"targets",[]);c(this,"messages",new Map);this.robots=this.createRobots(1e3,t,e),this.targets=this.createTargets(10,t,e)}createRobots(t,e,i){return new Array(t).fill(null).map((s,r)=>new P(`Robot ${r}`,g.randomInRectangle(e,i),Math.random()>.5?u.storage:u.source,Math.random()>.5?y.red:y.green,n=>this.receiveMessages(n),(n,d)=>this.sendMessage(n,d),n=>this.reachedTarget(n,b)))}createTargets(t,e,i){return new Array(t).fill(null).map((s,r)=>new I(g.randomInRectangle(e,i),Math.random()<.5?y.red:y.green,Math.random()<.5?u.storage:u.source))}reachedTarget(t,e){return this.getTargetsInRadius(t,e).some(s=>s.type===t.type&&s.color===t.color&&t.location.distance(s.location)<=e)}getTargetsInRadius(t,e){return this.targets.filter(i=>t.location.distance(i.location)<=e)}getRobotsInRadius(t,e){return this.robots.filter(i=>t.location.distance(i.location)<=e&&t!==i)}sendMessage(t,e){this.messages.set(t,e)}receiveMessages(t){return this.getRobotsInRadius(t,E).filter(s=>this.messages.has(s)).map(s=>this.messages.get(s))}}class F{constructor(){c(this,"canvas");c(this,"ctx");c(this,"field");this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d"),this.resizeCanvas(),this.field=new C(this.fieldWidth,this.fieldHeight),window.addEventListener("resize",()=>{this.handleResize()})}get width(){return this.canvas.width}get fieldWidth(){return this.width-l}get height(){return this.canvas.height}get fieldHeight(){return this.height-l}handleResize(){this.resizeCanvas(),this.field.robots.forEach(t=>t.location.stayInBounds(this.fieldWidth,this.fieldHeight)),this.field.targets.forEach(t=>t.location.stayInBounds(this.fieldWidth,this.fieldHeight))}resizeCanvas(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}step(){this.clearCanvas(),this.drawField(),this.stepField(),requestAnimationFrame(()=>this.step())}stepField(){this.field.robots.forEach(t=>t.step(this.fieldWidth,this.fieldHeight))}drawField(){this.field.robots.forEach(t=>t.draw(this.ctx)),this.field.targets.forEach(t=>t.draw(this.ctx))}}const N=new F;N.step();
